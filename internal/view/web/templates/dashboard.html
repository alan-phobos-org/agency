<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agency Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css">
  <style>
    .status-badge { font-size: 0.75rem; }
    .card-task { border-left: 3px solid var(--tblr-primary); }
    .task-preview { font-size: 0.85rem; color: var(--tblr-muted); }
    .refresh-indicator { opacity: 0; transition: opacity 0.2s; }
    .refresh-indicator.active { opacity: 1; }
    #submitResult { display: none; }
    #submitResult.show { display: block; }
    .session-card { border-left: 3px solid var(--tblr-purple); }
    .session-tasks { max-height: 200px; overflow-y: auto; }
    .session-task { padding: 0.5rem; border-bottom: 1px solid var(--tblr-border-color); }
    .session-task:last-child { border-bottom: none; }
  </style>
</head>
<body class="theme-light">
  <div class="page">
    <header class="navbar navbar-expand-md navbar-light d-print-none">
      <div class="container-xl">
        <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
          <span class="text-primary">Agency</span> Dashboard
        </h1>
        <div class="navbar-nav flex-row order-md-last">
          <span class="refresh-indicator badge bg-blue-lt me-2" id="refreshIndicator">Refreshing...</span>
          <span class="badge bg-green-lt">Connected</span>
        </div>
      </div>
    </header>

    <div class="page-wrapper">
      <div class="page-body">
        <div class="container-xl">
          <!-- Agents Section -->
          <div class="card mb-3">
            <div class="card-header">
              <h3 class="card-title">Agents</h3>
              <div class="card-actions">
                <span class="badge bg-azure" id="agentCount">0</span>
              </div>
            </div>
            <div class="card-body">
              <div class="row row-deck row-cards" id="agentGrid">
                <div class="col-12 text-muted">No agents discovered</div>
              </div>
            </div>
          </div>

          <!-- Directors Section -->
          <div class="card mb-3">
            <div class="card-header">
              <h3 class="card-title">Directors</h3>
              <div class="card-actions">
                <span class="badge bg-purple" id="directorCount">0</span>
              </div>
            </div>
            <div class="card-body">
              <div class="row row-deck row-cards" id="directorGrid">
                <div class="col-12 text-muted">No directors discovered</div>
              </div>
            </div>
          </div>

          <!-- Sessions Section -->
          <div class="card mb-3">
            <div class="card-header">
              <h3 class="card-title">Sessions</h3>
              <div class="card-actions">
                <span class="badge bg-purple" id="sessionCount">0</span>
              </div>
            </div>
            <div class="card-body">
              <div class="row row-deck row-cards" id="sessionGrid">
                <div class="col-12 text-muted">No active sessions</div>
              </div>
            </div>
          </div>

          <!-- Task Submission -->
          <div class="card mb-3">
            <div class="card-header">
              <h3 class="card-title">Submit Task</h3>
            </div>
            <div class="card-body">
              <form id="taskForm">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Agent</label>
                    <select class="form-select" id="agentSelect" required>
                      <option value="">Select an idle agent...</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Session</label>
                    <select class="form-select" id="sessionSelect">
                      <option value="">New session</option>
                    </select>
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label">Timeout (s)</label>
                    <input type="number" class="form-control" id="timeout" value="1800" min="1">
                  </div>
                  <div class="col-md-2 mb-3">
                    <label class="form-label">Model</label>
                    <select class="form-select" id="model">
                      <option value="">Auto</option>
                      <option value="opus">Opus</option>
                      <option value="sonnet">Sonnet</option>
                      <option value="haiku">Haiku</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Prompt</label>
                  <textarea class="form-control" id="prompt" rows="4" required placeholder="Describe the task..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                  <span class="spinner-border spinner-border-sm d-none" id="submitSpinner"></span>
                  Submit Task
                </button>
              </form>
              <div id="submitResult" class="mt-3 alert"></div>
            </div>
          </div>

          <!-- Active Task Monitor -->
          <div class="card" id="taskMonitor" style="display: none;">
            <div class="card-header">
              <h3 class="card-title">Task Monitor</h3>
            </div>
            <div class="card-body">
              <div id="taskDetails"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
  <script>
    // Get auth token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token') || '';

    // Tracked task for monitoring
    let activeTask = null;

    // Clear stale sessions on page load (refresh clears cache)
    localStorage.removeItem('agency_sessions');

    // Sessions storage: { sessionId: { agentUrl, tasks: [{taskId, state, prompt}], createdAt } }
    const sessions = {};

    function saveSessions() {
      localStorage.setItem('agency_sessions', JSON.stringify(sessions));
    }

    // API helper
    async function api(path, options = {}) {
      const url = new URL(path, window.location.origin);
      if (token) url.searchParams.set('token', token);

      const resp = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...(options.headers || {})
        }
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ message: resp.statusText }));
        throw new Error(err.message || `HTTP ${resp.status}`);
      }
      return resp.json();
    }

    // Render agent card
    function renderAgentCard(agent) {
      const stateColors = {
        'idle': 'bg-green',
        'working': 'bg-yellow',
        'cancelling': 'bg-orange'
      };
      const stateColor = stateColors[agent.state] || 'bg-secondary';

      let taskInfo = '';
      if (agent.current_task) {
        taskInfo = `
          <div class="mt-2 task-preview">
            <strong>Task:</strong> ${agent.current_task.id}<br>
            <small>${escapeHtml(agent.current_task.prompt_preview || '')}</small>
          </div>`;
      }

      return `
        <div class="col-sm-6 col-lg-4">
          <div class="card ${agent.current_task ? 'card-task' : ''}">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <span class="badge ${stateColor} status-badge me-2">${agent.state}</span>
                <span class="text-muted small">${agent.url}</span>
              </div>
              <div class="small text-muted">
                Version: ${agent.version || 'unknown'}<br>
                Uptime: ${formatUptime(agent.uptime_seconds)}
              </div>
              ${taskInfo}
            </div>
          </div>
        </div>`;
    }

    // Render director card
    function renderDirectorCard(director) {
      return `
        <div class="col-sm-6 col-lg-4">
          <div class="card">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <span class="badge bg-purple status-badge me-2">director</span>
                <span class="text-muted small">${director.url}</span>
              </div>
              <div class="small text-muted">
                Version: ${director.version || 'unknown'}<br>
                Uptime: ${formatUptime(director.uptime_seconds)}
              </div>
            </div>
          </div>
        </div>`;
    }

    // Render session card
    function renderSessionCard(sessionId, session) {
      const taskCount = session.tasks ? session.tasks.length : 0;
      const lastTask = session.tasks && session.tasks.length > 0 ? session.tasks[session.tasks.length - 1] : null;
      const stateColors = {
        'completed': 'bg-green',
        'failed': 'bg-red',
        'working': 'bg-yellow',
        'queued': 'bg-secondary'
      };
      const lastState = lastTask ? lastTask.state : 'unknown';

      return `
        <div class="col-sm-6 col-lg-4">
          <div class="card session-card">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <span class="badge ${stateColors[lastState] || 'bg-secondary'} status-badge">${lastState}</span>
                <button class="btn btn-sm btn-outline-primary" onclick="continueSession('${sessionId}')">Continue</button>
              </div>
              <div class="small text-muted mb-2">
                Session: ${sessionId.slice(0, 8)}...<br>
                Agent: ${session.agentUrl}<br>
                Tasks: ${taskCount}
              </div>
              <div class="session-tasks">
                ${(session.tasks || []).slice(-3).map(t => `
                  <div class="session-task small">
                    <span class="badge ${stateColors[t.state] || 'bg-secondary'} me-1">${t.state}</span>
                    ${escapeHtml((t.prompt || '').slice(0, 40))}${(t.prompt || '').length > 40 ? '...' : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>`;
    }

    // Update sessions display
    function updateSessionsUI() {
      const sessionGrid = document.getElementById('sessionGrid');
      const sessionSelect = document.getElementById('sessionSelect');
      const sessionIds = Object.keys(sessions);

      document.getElementById('sessionCount').textContent = sessionIds.length;

      if (sessionIds.length > 0) {
        sessionGrid.innerHTML = sessionIds.map(id => renderSessionCard(id, sessions[id])).join('');
      } else {
        sessionGrid.innerHTML = '<div class="col-12 text-muted">No active sessions</div>';
      }

      // Update session dropdown, preserving current selection
      const currentSessionValue = sessionSelect.value;
      sessionSelect.innerHTML = '<option value="">New session</option>' +
        sessionIds.map(id => {
          const s = sessions[id];
          const taskCount = s.tasks ? s.tasks.length : 0;
          return `<option value="${id}">${id.slice(0, 8)}... (${taskCount} tasks, ${s.agentUrl})</option>`;
        }).join('');
      if (currentSessionValue && sessionIds.includes(currentSessionValue)) {
        sessionSelect.value = currentSessionValue;
      }
    }

    // Continue session - pre-fill form
    function continueSession(sessionId) {
      const session = sessions[sessionId];
      if (!session) return;

      document.getElementById('sessionSelect').value = sessionId;
      document.getElementById('agentSelect').value = session.agentUrl;
      document.getElementById('prompt').focus();
    }

    // Update dashboard
    async function refresh() {
      const indicator = document.getElementById('refreshIndicator');
      indicator.classList.add('active');

      try {
        const [agents, directors] = await Promise.all([
          api('/api/agents'),
          api('/api/directors')
        ]);

        // Update agent grid
        const agentGrid = document.getElementById('agentGrid');
        if (agents.length > 0) {
          agentGrid.innerHTML = agents.map(renderAgentCard).join('');
        } else {
          agentGrid.innerHTML = '<div class="col-12 text-muted">No agents discovered</div>';
        }
        document.getElementById('agentCount').textContent = agents.length;

        // Update director grid
        const directorGrid = document.getElementById('directorGrid');
        if (directors.length > 0) {
          directorGrid.innerHTML = directors.map(renderDirectorCard).join('');
        } else {
          directorGrid.innerHTML = '<div class="col-12 text-muted">No directors discovered</div>';
        }
        document.getElementById('directorCount').textContent = directors.length;

        // Update agent select dropdown
        const agentSelect = document.getElementById('agentSelect');
        const currentValue = agentSelect.value;
        agentSelect.innerHTML = '<option value="">Select an idle agent...</option>' +
          agents.filter(a => a.state === 'idle').map(a =>
            `<option value="${a.url}">${a.url} (${a.state})</option>`
          ).join('');
        if (currentValue && agents.some(a => a.url === currentValue)) {
          agentSelect.value = currentValue;
        }

        // Poll active task if any
        if (activeTask) {
          await pollTask();
        }

        // Update sessions UI
        updateSessionsUI();
      } catch (err) {
        console.error('Refresh failed:', err);
      } finally {
        indicator.classList.remove('active');
      }
    }

    // Poll active task status
    async function pollTask() {
      if (!activeTask) return;

      try {
        const status = await api(`/api/task/${activeTask.taskId}?agent_url=${encodeURIComponent(activeTask.agentUrl)}`);

        const monitor = document.getElementById('taskMonitor');
        const details = document.getElementById('taskDetails');

        const stateColors = {
          'queued': 'bg-secondary',
          'working': 'bg-yellow',
          'completed': 'bg-green',
          'failed': 'bg-red',
          'cancelled': 'bg-orange'
        };

        details.innerHTML = `
          <div class="mb-2">
            <span class="badge ${stateColors[status.state] || 'bg-secondary'}">${status.state}</span>
            <strong class="ms-2">${status.task_id}</strong>
          </div>
          <div class="small text-muted mb-2">
            Agent: ${activeTask.agentUrl}<br>
            Duration: ${status.duration_seconds ? status.duration_seconds.toFixed(1) + 's' : 'running...'}
          </div>
          ${status.output ? `<pre class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow: auto;">${escapeHtml(status.output)}</pre>` : ''}
          ${status.error ? `<div class="alert alert-danger">${escapeHtml(status.error.message)}</div>` : ''}
        `;
        monitor.style.display = 'block';

        // Update session state if completed
        if (['completed', 'failed', 'cancelled'].includes(status.state)) {
          if (activeTask.sessionId && sessions[activeTask.sessionId]) {
            const session = sessions[activeTask.sessionId];
            const taskEntry = session.tasks.find(t => t.taskId === activeTask.taskId);
            if (taskEntry) {
              taskEntry.state = status.state;
              saveSessions();
            }
          }
          activeTask = null;
        }
      } catch (err) {
        console.error('Task poll failed:', err);
      }
    }

    // Submit task
    document.getElementById('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('submitBtn');
      const spinner = document.getElementById('submitSpinner');
      const result = document.getElementById('submitResult');

      btn.disabled = true;
      spinner.classList.remove('d-none');
      result.classList.remove('show', 'alert-success', 'alert-danger');

      try {
        const agentUrl = document.getElementById('agentSelect').value;
        const prompt = document.getElementById('prompt').value;
        const sessionId = document.getElementById('sessionSelect').value;

        const body = {
          agent_url: agentUrl,
          prompt: prompt
        };

        // Include session_id if continuing an existing session
        if (sessionId) {
          body.session_id = sessionId;
        }

        const timeout = parseInt(document.getElementById('timeout').value);
        if (timeout > 0) body.timeout_seconds = timeout;

        const model = document.getElementById('model').value;
        if (model) body.model = model;

        const resp = await api('/api/task', {
          method: 'POST',
          body: JSON.stringify(body)
        });

        result.className = 'mt-3 alert alert-success show';
        result.textContent = `Task submitted: ${resp.task_id} (session: ${resp.session_id ? resp.session_id.slice(0, 8) + '...' : 'new'})`;

        // Track session
        const sid = resp.session_id;
        if (sid) {
          if (!sessions[sid]) {
            sessions[sid] = { agentUrl: agentUrl, tasks: [], createdAt: new Date().toISOString() };
          }
          sessions[sid].tasks.push({ taskId: resp.task_id, state: 'queued', prompt: prompt });
          saveSessions();
        }

        // Start monitoring
        activeTask = { taskId: resp.task_id, agentUrl: resp.agent_url, sessionId: sid };

        // Clear prompt but keep other fields for follow-ups
        document.getElementById('prompt').value = '';

        // Refresh to show agent as busy
        await refresh();
      } catch (err) {
        result.className = 'mt-3 alert alert-danger show';
        result.textContent = `Error: ${err.message}`;
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
      }
    });

    // Helpers
    function formatUptime(seconds) {
      if (!seconds) return 'unknown';
      if (seconds < 60) return `${Math.floor(seconds)}s`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
      return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
    }

    // Start refresh loop
    refresh();
    setInterval(refresh, 1000);
  </script>
</body>
</html>
