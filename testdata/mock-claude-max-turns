#!/bin/bash
# Mock Claude CLI for testing max_turns auto-resume behavior
# First N calls return error_max_turns, then returns success
# Uses MOCK_MAX_TURNS_COUNTER file to track calls

# Ensure basic commands are available (PATH may be restricted in subprocess)
export PATH="/usr/bin:/bin:$PATH"

SESSION_ID=""
RESUME=false
CAPTURE_NEXT=""

for arg in "$@"; do
    if [ "$CAPTURE_NEXT" = "session" ]; then
        SESSION_ID="$arg"
        CAPTURE_NEXT=""
        continue
    fi
    case "$arg" in
        --session-id)
            CAPTURE_NEXT="session"
            ;;
        --resume)
            RESUME=true
            # For resume, session ID is the next arg
            CAPTURE_NEXT="session"
            ;;
    esac
done

# If no session ID, generate one
if [ -z "$SESSION_ID" ]; then
    SESSION_ID="max-turns-session-$$"
fi

# Track call count using counter file
COUNTER_FILE="${MOCK_MAX_TURNS_COUNTER:-/tmp/mock-claude-max-turns-counter}"

# Read current count
if [ -f "$COUNTER_FILE" ]; then
    COUNT=$(cat "$COUNTER_FILE")
else
    COUNT=0
fi

# Increment and write
COUNT=$((COUNT + 1))
echo "$COUNT" > "$COUNTER_FILE"

# How many times to return max_turns error before success
# Default: 2 (so 3rd call succeeds)
FAIL_COUNT="${MOCK_MAX_TURNS_FAIL_COUNT:-2}"

# Emit system init event
echo "{\"type\":\"system\",\"subtype\":\"init\",\"session_id\":\"$SESSION_ID\",\"model\":\"sonnet\"}"

if [ "$COUNT" -le "$FAIL_COUNT" ]; then
    # Emit assistant message
    echo "{\"type\":\"assistant\",\"message\":{\"content\":[{\"type\":\"text\",\"text\":\"Hit max turns limit (call $COUNT)\"}]}}"
    # Return error_max_turns - note this still has exit_code 0 like real Claude
    echo "{\"type\":\"result\",\"subtype\":\"error_max_turns\",\"session_id\":\"$SESSION_ID\",\"duration_ms\":1000,\"num_turns\":50,\"total_cost_usd\":0.05}"
else
    # Emit assistant message
    echo "{\"type\":\"assistant\",\"message\":{\"content\":[{\"type\":\"text\",\"text\":\"Task completed after $COUNT attempts\"}]}}"
    # Return success
    echo "{\"type\":\"result\",\"subtype\":\"success\",\"session_id\":\"$SESSION_ID\",\"duration_ms\":500,\"num_turns\":5,\"total_cost_usd\":0.01}"
fi
