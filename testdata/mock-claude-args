#!/bin/bash
# Mock Claude CLI that captures args for testing
# Writes the received prompt to a file for verification

PROMPT=""
CAPTURE_NEXT=false

for arg in "$@"; do
    if [ "$CAPTURE_NEXT" = true ]; then
        PROMPT="$arg"
        break
    fi
    if [ "$arg" = "--" ]; then
        CAPTURE_NEXT=true
    fi
done

# If no -- separator was used, try to get prompt after -p
if [ -z "$PROMPT" ]; then
    CAPTURE_NEXT=false
    for arg in "$@"; do
        if [ "$CAPTURE_NEXT" = true ]; then
            PROMPT="$arg"
            break
        fi
        if [ "$arg" = "-p" ]; then
            CAPTURE_NEXT=true
        fi
    done
fi

# Write prompt to file specified by MOCK_CLAUDE_OUTPUT env var
if [ -n "$MOCK_CLAUDE_OUTPUT" ]; then
    echo "$PROMPT" > "$MOCK_CLAUDE_OUTPUT"
fi

# Return success with stream-json format
echo '{"type":"system","subtype":"init","session_id":"test-session-args","model":"sonnet"}'
echo "{\"type\":\"assistant\",\"message\":{\"content\":[{\"type\":\"text\",\"text\":\"Prompt received: $PROMPT\"}]}}"
echo '{"type":"result","subtype":"success","session_id":"test-session-args","duration_ms":100,"num_turns":1,"total_cost_usd":0.001}'
